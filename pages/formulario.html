<!DOCTYPE html>
<html>
	<head>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>Felicidade no Trabalho</title>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
		<script src="/socket.io/socket.io.js"></script>
    </head>
    <style>
        body{
            text-align: center;
	        background-color: lavender;
	        margin: 5vh 0vw 0vh 0vw;
        }
        .login,#regist_form {
            position:relative;
            top: 40%;
            text-align: center;
            margin-top: 2vh;
            width: 99%;
            height: 10vh;
            color: gray;
            background-color: white;
            border: 5px solid rgb(255,100,0);
            border-radius: 5px;
            font-size: 40px;
            font-weight: bolder;
        }
        #regist_form {
            width: 40%;
        }
        #initiate {
            width: 40vw;
        }
        #guest {
            width: 21vw;
            height: 10vh;
        }

#title {
font-size: 50px;
}
.questions{
border: 3px solid rgb(255,100,0);
width: 10vw;
height: 5vh;
}
    </style>
    <body>
        <br><br>
        <div class="login_div">
            <span class="login" id="title" style="border:none;background-color:lavender;text-align:center;color:rgb(255,100,0);-webkit-text-stroke: 0.5px gray;font-family: arial">Inicio de Sessão</span><br>
            <input class="login" id="nick" placeholder="nickname" type="password"><br>
            <input class="login" id="password"placeholder="palavra-passe" type="password"><br>
            <button class="login" id="initiate">Entrar</button><br>
        </div>
        <div class="formulario" style="display:none;">

        </div>
        <script>
            var table2 = []
            var maxq = 0
            table2 = {
                [0] : {
                    title:"felicidade no trabalho",
                    options:[
                        {label:"",points:0},
                        {label:"muito feliz",points:10},
                        {label:"feliz",points:0},
                        {label:"menos feliz",points:0},
                        {label:"infeliz",points:0}
                    ]
                },
                [1] : {
                    title:"Ha algum metodo de descanço para promover a felicidade?",
                    options:[
                        {label:"",points:0},
                        {label:"sim",points:10},
                        {label:"nao",points:0}
                    ]
                }
            }
            function initM (newm,initm) {
                if (newm == null) {newm="Inicio de Sessão"};
                $("#title").html(newm);
                    setTimeout(function(){
                        $("#title").html(initm)
                    },3000);
            }
            function enter() {
                $('.login_div').hide();
                    
                    var count = 0
                    for (var o = 0; o < 100; o++) {
                        if (table2[o] != null){
                            count ++;
                        }
                    }
                    
                for (var i = 0; i < count; i++) {
                    var options = ""
                    
                    var count2 = 0
                    for (var o = 0; o < 10; o++) {
                        if (table2[i].options[o] != null){
                            count2 ++;
                        }
                    }
                    maxq = count2;
                    for (var k = 0; k < count2; k++){
                        options = options + "<option value="+k+"_"+table2[i].options[k].points+">"+table2[i].options[k].label+"</option>"
                    }
                   
                    var txt = "<p id=\"title\" style=\"color:rgb(255,100,0);\">"+table2[i].title+"</p><select class=\"questions\" id=\"question_"+i+"\">"+options+"</select><br><br>"
                    //console.log(txt);
                    $(".formulario").append(txt);
                }
                $(".formulario").append("<button id=\"regist_form\" onclick=\"getAnswers()\">Participar</button>");
                $(".formulario").show();
            }
            function getAnswers() {
                        var submitdata = [];
                        var submit_error = false;
                        
                    for(i=0; i < maxq-1; i++){
                        var index = $("#question_"+i).val();
                        if(index.split("_")[0]==0){
                            submit_error = true;
                            submitdata = [];
                            break;
                        }
                        
                        submitdata[i] = {index:index.split("_")[0],points:index.split("_")[1]}
                        
                    }
                    var count = 0
                    $.getJSON('https://ipapi.co/json/', function(data) {
                    
                        if (data.ip == null){data.ip = "0.0.0.0"};
                        if(!submit_error){
                            //socket.emit("submit",{data:submitdata,ip:data.ip})
                        }else{
                            var errormessg = "<div id=\"errormessg\"style=\"text-align: center; margin-top: 10px; width: 100%\">Preenche todos os campos, por favor</div>";

                                if(document.getElementById("errormessg") == null){
                                    $("body").append(errormessg);
                                    $("#errormessg").delay(5000).fadeOut(1000);
                                }else{
                                    $("#errormessg").fadeIn(100).delay(5000).fadeOut(1000);
                                }
                        }
                    });
            }
            const socket = io();
            $("#initiate").click(function(){
                var a = $("#nick").val();
                var b = $("#password").val();
                if (a == "" || b == "") {
                    initM("Valores Invalidos","Inicio de Sessão");
                }else{
                    socket.emit('checkI',{a:a,b:b})
                    
                    
                }
            })
            socket.on('checkedI',function(data){
                if (data.bool == true) {
                    enter();
                }else{
                    initM("Credenciais Incorretas<br>Tente novamente.","Inicio de Sessão")
                }
                
            })
            window.onload = function(){
                $.getJSON('https://ipapi.co/json/', function(data) {
                    socket.emit("newCInfo",{data:data});
                });
            };
        </script>
    </body>
